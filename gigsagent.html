<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gigs Hub - Agent Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css">
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        .spinner {
            width: 40px;
            height: 40px;
            background-image: url('https://media.giphy.com/media/3oEjI6SIIHBdRxXI40/giphy.gif');
            background-size: contain;
            background-repeat: no-repeat;
        }
        .btn-hover:hover {
            filter: brightness(110%);
            transform: translateY(-1px);
            transition: all 0.2s ease;
        }
    </style>
</head>
<body class="bg-gray-900 flex flex-col items-center justify-between min-h-screen text-sm sm:text-base">
    <nav class="bg-gray-800 w-full py-2 sm:py-4 flex justify-center items-center fixed top-0 z-10">
        <h1 class="text-yellow-400 text-lg sm:text-xl font-bold"><span class="material-icons mr-1 align-middle text-base sm:text-lg">bolt</span>Gigs Hub - Agent Portal</h1>
    </nav>

    <div id="main-content" class="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg w-full max-w-md mt-14 sm:mt-20 mx-2 sm:mx-4">
        <div id="activation-section" class="hidden">
            <h2 class="text-white text-xl sm:text-2xl font-semibold mb-3"><span class="material-icons mr-1 align-middle">vpn_key</span>Activate Agent Portal</h2>
            <p class="text-gray-300 mb-4">Activate your agent portal for exclusive discounts on data bundles.</p>
            <button id="activate-button" class="bg-green-500 text-white px-3 py-1 sm:px-4 sm:py-2 rounded text-xs sm:text-sm btn-hover"><span class="material-icons mr-1 align-middle text-sm">credit_card</span>Pay GHS 50 to Activate</button>
        </div>

        <div id="bundle-purchase-section" class="hidden">
            <h2 class="text-white text-xl sm:text-2xl font-semibold mb-3"><span class="material-icons mr-1 align-middle">shopping_cart</span>Purchase Bundle</h2>
            <div class="mb-3 sm:mb-4">
                <label for="phone-number" class="block text-gray-400 mb-1 sm:mb-2"><span class="material-icons mr-1 align-middle text-sm">phone</span>PHONE NUMBER</label>
                <input type="text" id="phone-number" class="w-full p-2 bg-gray-700 text-gray-300 rounded text-sm" placeholder="Enter phone number"/>
            </div>
            <div class="mb-3 sm:mb-4">
                <label for="network" class="block text-gray-400 mb-1 sm:mb-2"><span class="material-icons mr-1 align-middle text-sm">network_cell</span>NETWORK</label>
                <select id="network" class="w-full p-2 bg-gray-700 text-gray-300 rounded text-sm">
                    <option value="">Select Network</option>
                    <option value="mtn">MTN</option>
                    <option value="at">AirtelTigo</option>
                </select>
            </div>
            <div class="mb-3 sm:mb-4">
                <label for="bundle-volume" class="block text-gray-400 mb-1 sm:mb-2"><span class="material-icons mr-1 align-middle text-sm">data_usage</span>BUNDLE VOLUME</label>
                <select id="bundle-volume" class="w-full p-2 bg-gray-700 text-gray-300 rounded text-sm">
                    <option value="">Select package</option>
                </select>
            </div>
            <div id="bundle-price" class="mb-3 sm:mb-4 text-gray-300"></div>
            <div class="flex space-x-2">
                <button id="send-bundle" class="bg-red-500 text-white px-3 py-1 sm:px-4 sm:py-2 rounded text-xs sm:text-sm btn-hover"><span class="material-icons mr-1 align-middle text-sm">send</span>Send Bundle</button>
            </div>
            <div id="loader" class="hidden mt-3 sm:mt-4 flex justify-center">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAxdZufEUNjmHNrOtOH4GFtd2joqJzs_sk",
            authDomain: "gigs-hub-a0f14.firebaseapp.com",
            projectId: "gigs-hub-a0f14",
            storageBucket: "gigs-hub-a0f14.firebasestorage.app",
            messagingSenderId: "997297677705",
            appId: "1:997297677705:web:34d11ec60893183499ed58"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // Initialize Notyf
        const notyf = new Notyf({
            duration: 3000,
            position: {x: 'right', y: 'top'},
        });

        // Elements
        const activationSection = document.getElementById('activation-section');
        const bundlePurchaseSection = document.getElementById('bundle-purchase-section');
        const activateButton = document.getElementById('activate-button');
        const loader = document.getElementById('loader');

        // Network prices (GHS per GB) - Reduced for agent portal
        const networkPrices = {
            mtn: 4.80, // 10% discount
            at: 4.5  // 25% discount
        };

        // Bundle volumes (in GB)
        const bundleVolumes = [1, 2, 3, 4, 5, 6, 7];

        // Authentication state observer
        onAuthStateChanged(auth, (user) => {
            if (user) {
                checkAgentStatus(user);
            } else {
                notyf.error('Please log in to access the agent portal');
                window.location.href = 'index.html'; // Redirect to main page
            }
        });

        // Check if the user has activated the agent portal
        function checkAgentStatus(user) {
            get(ref(database, 'users/' + user.uid + '/agentPortalActive'))
                .then((snapshot) => {
                    if (snapshot.exists() && snapshot.val() === true) {
                        showBundlePurchaseSection();
                    } else {
                        showActivationSection();
                    }
                })
                .catch((error) => {
                    console.error('Error checking agent status:', error);
                    notyf.error('Error checking agent status');
                });
        }

        // Show activation section
        function showActivationSection() {
            activationSection.classList.remove('hidden');
            bundlePurchaseSection.classList.add('hidden');
        }

        // Show bundle purchase section
        function showBundlePurchaseSection() {
            activationSection.classList.add('hidden');
            bundlePurchaseSection.classList.remove('hidden');
        }

        // Activate agent portal
        activateButton.addEventListener('click', () => {
            const user = auth.currentUser;
            if (user) {
                const handler = PaystackPop.setup({
                    key: 'pk_test_465904782c379e7b5eb53646745fec92442a3af4', // Replace with your actual Paystack public key
                    email: user.email,
                    amount: 5000, // Amount in pesewas (50 GHS)
                    currency: 'GHS',
                    ref: '' + Math.floor((Math.random() * 1000000000) + 1),
                    callback: function(response) {
                        set(ref(database, 'users/' + user.uid + '/agentPortalActive'), true)
                            .then(() => {
                                notyf.success('Agent portal activated successfully!');
                                showBundlePurchaseSection();
                            })
                            .catch((error) => {
                                console.error('Error activating agent portal:', error);
                                notyf.error('Error activating agent portal');
                            });
                    },
                    onClose: function() {
                        notyf.warning('Activation was not completed, window closed.');
                    }
                });
                handler.openIframe();
            } else {
                notyf.error('Please log in to activate the agent portal');
            }
        });

        // Network selection change handler
        document.getElementById('network').addEventListener('change', updateBundleOptions);

        // Bundle volume selection change handler
        document.getElementById('bundle-volume').addEventListener('change', updatePrice);

        // Update bundle options based on selected network
        function updateBundleOptions() {
            const network = document.getElementById('network').value;
            const bundleVolumeSelect = document.getElementById('bundle-volume');
            bundleVolumeSelect.innerHTML = '<option value="">Select package</option>';

            if (network) {
                bundleVolumes.forEach(volume => {
                    const option = document.createElement('option');
                    option.value = volume;
                    option.textContent = `${volume}GB`;
                    bundleVolumeSelect.appendChild(option);
                });
            }

            updatePrice();
        }

        // Update price based on selected network and volume
        function updatePrice() {
            const network = document.getElementById('network').value;
            const volume = document.getElementById('bundle-volume').value;
            const priceElement = document.getElementById('bundle-price');

            if (network && volume) {
                const price = networkPrices[network] * volume;
                priceElement.textContent = `Price: GHS ${price.toFixed(2)}`;
            } else {
                priceElement.textContent = '';
            }
        }

        // Send Bundle
        document.getElementById('send-bundle').addEventListener('click', () => {
            const user = auth.currentUser;
            if (!user) {
                notyf.error('Please log in to send a bundle');
                return;
            }

            const network = document.getElementById('network').value;
            const phoneNumber = document.getElementById('phone-number').value;
            const bundleVolume = document.getElementById('bundle-volume').value;

            if (network === '' || bundleVolume === '' || phoneNumber === '') {
                notyf.error('Please select a network, enter phone number, and select a package');
                return;
            }

            // Show loader
            loader.classList.remove('hidden');

            // Calculate price
            const bundlePrice = networkPrices[network] * bundleVolume;

            // Initialize Paystack payment
            const handler = PaystackPop.setup({
                key: 'pk_test_465904782c379e7b5eb53646745fec92442a3af4', // Replace with your actual Paystack public key
                email: user.email,
                amount: bundlePrice * 100, // Amount in pesewas
                currency: 'GHS',
                ref: '' + Math.floor((Math.random() * 1000000000) + 1),
                callback: function(response) {
                    // Hide loader
                    loader.classList.add('hidden');
                    notyf.success('Payment successful. Transaction reference: ' + response.reference);

                    // Call the API to send the bundle
                    sendBundle(network, phoneNumber, bundleVolume, response.reference);
                },
                onClose: function() {
                    // Hide loader
                    loader.classList.add('hidden');
                    notyf.warning('Transaction was not completed, window closed.');
                }
            });
            handler.openIframe();
        });

        // Function to send bundle via API
        async function sendBundle(network, phone, volume, reference) {
            const apiUrl = `https://console.hubnet.app/live/api/context/business/transaction/${network}-new-transaction`;
            const apiKey = 'v61fayeo5LeSlVy1AgjHqgXFrYAgogDr2E7'; // Replace with your actual API key

            const payload = {
                phone: phone,
                volume: volume * 1000, // Convert GB to MB
                reference: reference,
                referrer: auth.currentUser.phoneNumber || '',
                webhook: 'https://your-webhook-url.com' // Replace with your actual webhook URL
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'token': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.status) {
                    notyf.success('Bundle sent successfully!');
                    saveOrderToDatabase(network, phone, volume, reference, data.transaction_id);
                } else {
                    notyf.error('Failed to send bundle: ' + data.message);
                }
            } catch (error) {
                notyf.error('Error sending bundle: ' + error.message);
            }
        }

        // Function to save order to database
        function saveOrderToDatabase(network, phone, volume, reference, transactionId) {
            const user = auth.currentUser;
            if (!user) {
                notyf.error('Error: User not logged in');
                return;
            }

            const orderData = {
                network: network,
                phoneNumber: phone,
                bundleVolume: volume + 'GB',
                price: networkPrices[network] * volume,
                userId: user.uid,
                transactionReference: reference,
                transactionId: transactionId,
                timestamp: new Date().toISOString(),
                isAgentOrder: true
            };

            set(ref(database, 'orders/' + transactionId), orderData)
                .then(() => {
                    notyf.success('Order saved successfully');
                })
                .catch(error => {
                    console.error('Error saving order:', error);
                    notyf.error('Error saving order: ' + error.message);
                });
        }
    </script>
</body>
</html>

