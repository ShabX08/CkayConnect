<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Data Bundles Platform</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3.10.0/notyf.min.css">
    <script src="https://cdn.jsdelivr.net/npm/notyf@3.10.0/notyf.min.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <header>
        <nav class="navbar container">
            <div class="logo">
                <a href="#"><i class="fas fa-cloud"></i> DataBundles</a>
            </div>
            <ul class="nav-links">
                <li><a href="#"><i class="fas fa-home"></i> Home</a></li>
                <li><a href="login.html" id="loginLink"><i class="fas fa-sign-in-alt"></i> Login</a></li>
                <li><a href="#" id="accountBtn"><i class="fas fa-user"></i> Account</a></li>
                <li><a href="#" id="viewOrdersBtn"><i class="fas fa-box"></i> Orders</a></li>
            </ul>
            <div class="hamburger">
                <div class="line"></div>
                <div class="line"></div>
                <div class="line"></div>
            </div>
        </nav>
    </header>

    <div class="main-content">
        <section class="container">
            <div class="content">
                <h2><i class="fas fa-mobile-alt"></i> Send MTN Data Bundle</h2>

                <div class="alert">
                    <p><i class="fas fa-info-circle"></i> Your package will take up to 30 minutes to be delivered.
                        Make sure to double-check the phone number to avoid sending it to the wrong recipient.</p>
                </div>

                <form id="bundleForm">
                    <label for="dataAmount"><i class="fas fa-sim-card"></i> Quantity:</label>
                    <select id="dataAmount">
                        <option value="1GB" data-price="5">1GB - ₵5</option>
                        <option value="2GB" data-price="10">2GB - ₵10</option>
                        <option value="5GB" data-price="25">5GB - ₵25</option>
                    </select>

                    <label for="email"><i class="fas fa-envelope"></i> Email:</label>
                    <input type="email" id="email" placeholder="Enter your email" required>

                    <label for="beneficiaryNumber"><i class="fas fa-phone-alt"></i> Beneficiary Number:</label>
                    <input type="text" id="beneficiaryNumber" placeholder="Enter beneficiary number" required>

                    <button type="submit" id="payBtn" class="send-btn"><i class="fas fa-credit-card"></i> Send Bundle</button>
                </form>
            </div>
        </section>
    </div>

    <!-- Account Modal -->
    <div id="accountModal" class="modal">
        <div class="modal-content">
            <span id="closeAccountModal" class="close">&times;</span>
            <h2><i class="fas fa-user-circle"></i> Account Info</h2>
            <div class="account-info">
                <i class="fas fa-user"></i>
                <p><strong>Name:</strong> <span id="userName"></span></p>
                <i class="fas fa-envelope"></i>
                <p><strong>Email:</strong> <span id="userEmail"></span></p>
                <i class="fas fa-phone-alt"></i>
                <p><strong>Phone:</strong> <span id="userPhone"></span></p>
            </div>
            <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>
    </div>

    <!-- Orders Modal -->
    <div id="ordersModal" class="modal">
        <div class="modal-content">
            <span id="closeOrdersModal" class="close">&times;</span>
            <h2><i class="fas fa-boxes"></i> Your Orders</h2>
            <div id="ordersList">No orders found.</div>
        </div>
    </div>

    <footer>&copy; 2024 CkayConnect. All Rights Reserved. <i class="fas fa-copyright"></i></footer>

    <script type="module">
        // Initialize Notyf
        const notyf = new Notyf({
            duration: 3000,
            position: { x: 'right', y: 'top' }
        });

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getDatabase, ref, set, get, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAu2d2jW-80IfCDPV6Iex_tM2YU8jq7QXI",
            authDomain: "shabxstore-auth.firebaseapp.com",
            projectId: "shabxstore-auth",
            storageBucket: "shabxstore-auth.firebasestorage.app",
            messagingSenderId: "559599767419",
            appId: "1:559599767419:web:17f1a0eef0589d3dd077de"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // Event Listeners for User Actions
        document.getElementById("bundleForm").addEventListener("submit", function (e) {
            e.preventDefault();
            initiatePayment();
        });
        document.getElementById("accountBtn").addEventListener("click", showAccountDetails);
        document.getElementById("viewOrdersBtn").addEventListener("click", showOrders);
        document.getElementById("logoutBtn").addEventListener("click", () => {
            signOut(auth).then(() => {
                notyf.success('Logged out successfully.');
                window.location.href = 'login.html';
            }).catch((error) => {
                notyf.error('Logout failed: ' + error.message);
            });
        });

        document.getElementById("closeAccountModal").addEventListener("click", () => {
            document.getElementById("accountModal").style.display = 'none';
        });

        document.getElementById("closeOrdersModal").addEventListener("click", () => {
            document.getElementById("ordersModal").style.display = 'none';
        });

        // Check user authentication state
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('loginLink').style.display = 'none';
                document.getElementById('accountBtn').style.display = 'block';
                document.getElementById('viewOrdersBtn').style.display = 'block';
            } else {
                document.getElementById('loginLink').style.display = 'block';
                document.getElementById('accountBtn').style.display = 'none';
                document.getElementById('viewOrdersBtn').style.display = 'none';
            }
        });

        function initiatePayment() {
            const email = document.getElementById('email').value;
            const dataAmount = document.getElementById('dataAmount').value;
            const price = document.querySelector(`#dataAmount option[value="${dataAmount}"]`).getAttribute('data-price');
            const beneficiaryNumber = document.getElementById('beneficiaryNumber').value;

            if (!email || !beneficiaryNumber || !dataAmount) {
                notyf.error('Please fill all fields.');
                return;
            }

            const handler = PaystackPop.setup({
                key: 'pk_test_465904782c379e7b5eb53646745fec92442a3af4',
                email: email,
                amount: price * 100,
                currency: 'GHS',
                callback: function (response) {
                    notyf.success('Payment successful! Ref: ' + response.reference);
                    saveOrder(response.reference, dataAmount, beneficiaryNumber, price);
                },
                onClose: function () {
                    notyf.error('Payment was cancelled.');
                }
            });
            handler.openIframe();
        }

        function saveOrder(reference, dataAmount, beneficiaryNumber, price) {
            const user = auth.currentUser;
            if (user) {
                const orderRef = ref(db, `orders/${user.uid}/${reference}`);
                set(orderRef, {
                    dataAmount,
                    beneficiaryNumber,
                    status: 'processing',
                    paymentReference: reference,
                    date: new Date().toISOString(),
                    price,
                    userName: user.displayname || 'N/A',
                    userEmail: user.email
                }).then(() => {
                    notyf.success('Order saved successfully!');
                    simulateOrderProgress(reference);
                }).catch((error) => {
                    console.error('Error saving order:', error);
                    notyf.error('Failed to save order.');
                });
            } else {
                notyf.error('User not authenticated. Please log in.');
            }
        }

        function simulateOrderProgress(reference) {
            const user = auth.currentUser;
            if (user) {
                setTimeout(() => {
                    updateOrderStatus(reference, 'processing');
                }, 20000);

                setTimeout(() => {
                    updateOrderStatus(reference, 'delivered');
                }, 20000);
            }
        }

        function updateOrderStatus(reference, status) {
            const user = auth.currentUser;
            if (user) {
                const orderRef = ref(db, `orders/${user.uid}/${reference}`);
                update(orderRef, {
                    status: status
                }).then(() => {
                    console.log('Order status updated to', status);
                    notyf.success(`Order status updated to ${status}`);
                }).catch((error) => {
                    console.error('Error updating order status:', error);
                    notyf.error('Failed to update order status');
                });
            }
        }

        function showAccountDetails() {
            const user = auth.currentUser;
            if (user) {
                get(ref(db, `users/${user.uid}`)).then((snapshot) => {
                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        document.getElementById('userName').textContent = userData.name || 'No name';
                        document.getElementById('userEmail').textContent = user.email;
                        document.getElementById('userPhone').textContent = userData.phone || 'No phone number';
                        document.getElementById('accountModal').style.display = 'block';
                    } else {
                        notyf.error('User data not found.');
                    }
                }).catch((error) => {
                    console.error('Error fetching user data:', error);
                    notyf.error('Failed to fetch user data.');
                });
            } else {
                notyf.error('User not authenticated.');
            }
        }

        function showOrders() {
            const user = auth.currentUser;
            const ordersList = document.getElementById('ordersList');
            const ordersModal = document.getElementById('ordersModal');
            
            ordersList.innerHTML = '<p>Loading orders...</p>';

            if (user) {
                get(ref(db, `orders/${user.uid}`))
                    .then((snapshot) => {
                        ordersList.innerHTML = '';
                        if (snapshot.exists()) {
                            const orders = snapshot.val();
                            const orderIds = Object.keys(orders);
                            orderIds.reverse();

                            orderIds.forEach((orderId) => {
                                const order = orders[orderId];
                                const orderDate = new Date(order.date);
                                const formattedOrderDate = orderDate.toLocaleString('en-GB', {
                                    day: '2-digit',
                                    month: '2-digit',
                                    year: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit',
                                    second: '2-digit'
                                });

                                const orderItem = document.createElement('div');
                                orderItem.classList.add('order-item');

                                orderItem.innerHTML = `
                                    <div class="order-header">
                                        <p class="order-status ${order.status}"><strong>Status:</strong> ${order.status}</p>
                                        <p><strong>Order ID:</strong> ${orderId}</p>
                                    </div>
                                    <div class="order-details">
                                        <p><strong>Data Bundle:</strong> ${order.dataAmount}</p>
                                        <p><strong>Beneficiary Number:</strong> ${order.beneficiaryNumber}</p>
                                        <p><strong>Price:</strong> ₵${order.price}</p>
                                    </div>
                                    <div class="order-footer">
                                        <p><strong>Order Date & Time:</strong> ${formattedOrderDate}</p>
                                    </div>
                                `;
                                ordersList.appendChild(orderItem);
                            });
                        } else {
                            ordersList.innerHTML = '<p>No orders found.</p>';
                        }
                        ordersModal.style.display = 'block';
                    })
                    .catch((error) => {
                        console.error('Error fetching orders:', error);
                        notyf.error('Failed to load orders.');
                    });
            } else {
                notyf.error('User not authenticated.');
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            const hamburger = document.querySelector('.hamburger');
            const navLinks = document.querySelector('.nav-links');

            hamburger.addEventListener('click', () => {
                hamburger.classList.toggle('active');
                navLinks.classList.toggle('active');
            });

            const links = document.querySelectorAll('.nav-links li a');
            links.forEach(link => {
                link.addEventListener('click', () => {
                    hamburger.classList.remove('active');
                    navLinks.classList.remove('active');
                });
            });
        });
    </script>
</body>

</html>
