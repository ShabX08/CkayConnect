<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Gigs Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css">
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        .spinner {
            width: 100px;
            height: 100px;
            background-image: url('https://media.giphy.com/media/3oEjI6SIIHBdRxXI40/giphy.gif');
            background-size: contain;
            background-repeat: no-repeat;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .btn-hover:hover {
            filter: brightness(110%);
            transform: translateY(-1px);
            transition: all 0.2s ease;
        }
        .active-nav {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 9999px;
        }
        @media (max-width: 640px) {
            .text-sm { font-size: 0.75rem; }
            .text-base { font-size: 0.875rem; }
            .text-lg { font-size: 1rem; }
            .text-xl { font-size: 1.125rem; }
            .text-2xl { font-size: 1.25rem; }
        }
    </style>
</head>
<body class="bg-gray-900 flex flex-col items-center justify-between min-h-screen text-sm sm:text-base">
    <!-- Navbar -->
    <nav class="bg-gray-800 w-full py-2 sm:py-4 flex justify-center items-center fixed top-0 z-10">
        <h1 class="text-yellow-400 text-lg sm:text-xl font-bold"><span class="material-icons mr-1 align-middle text-base sm:text-lg">bolt</span>Gigs Hub</h1>
    </nav>

    <!-- Main Content -->
    <div id="main-content" class="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg w-full max-w-md mt-14 sm:mt-20 mx-2 sm:mx-4 hidden">
        <!-- Home Section -->
        <div id="home-section" class="hidden">
            <h2 class="text-white text-xl sm:text-2xl font-semibold mb-3"><span class="material-icons mr-1 align-middle">home</span>Home</h2>
            <div id="user-greeting" class="text-yellow-400 text-lg mb-4"></div>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-gray-700 p-3 rounded">
                    <p class="text-gray-300 text-sm">Total Spent</p>
                    <p id="total-spent" class="text-white text-lg font-semibold"></p>
                </div>
                <div class="bg-gray-700 p-3 rounded">
                    <p class="text-gray-300 text-sm">Orders Made</p>
                    <p id="orders-made" class="text-white text-lg font-semibold"></p>
                </div>
                <div class="bg-gray-700 p-3 rounded">
                    <p class="text-gray-300 text-sm">Data Activated</p>
                    <p id="data-activated" class="text-white text-lg font-semibold"></p>
                </div>
                <div class="bg-gray-700 p-3 rounded">
                    <p class="text-gray-300 text-sm">Last Order</p>
                    <p id="last-order" class="text-white text-lg font-semibold"></p>
                </div>
            </div>
            <div class="flex space-x-4">
                <button id="purchase-button" class="flex-1 bg-blue-500 text-white px-4 py-2 rounded text-sm btn-hover flex items-center justify-center">
                    <span class="material-icons mr-2">shopping_cart</span>Purchase
                </button>
                <a href="agent.html"><button class="flex-1 bg-green-500 text-white px-4 py-2 rounded text-sm btn-hover flex items-center justify-center">
                    <span class="material-icons mr-2">support_agent</span>Agent Portal
                </button></a>
            </div>
        </div>

        <!-- Bundle Purchase Section -->
        <div id="bundle-purchase-section" class="hidden">
            <div class="flex items-center mb-3 sm:mb-4">
                <img src="https://storage.googleapis.com/a1aa/image/05S6wOFvzhqLJp5bN2mUJ44neY6ge1sDZrNMviWL3Bv3tifnA.jpg" alt="MTN logo" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full" width="32" height="32"/>
                <h1 class="text-yellow-400 text-lg sm:text-xl font-bold ml-2">MTN OFFERS</h1>
            </div>
            <div class="bg-green-500 text-white p-2 rounded mb-3 sm:mb-4">
                <span class="material-icons mr-1 align-middle">info</span>
             Your bundle will arrive within the next 20 minutes.
            </div>
            <div class="mb-3 sm:mb-4">
                <label for="phone-number" class="block text-gray-400 mb-1 sm:mb-2"><span class="material-icons mr-1 align-middle text-sm">phone</span>PHONE NUMBER</label>
                <input type="text" id="phone-number" class="w-full p-2 bg-gray-700 text-gray-300 rounded text-sm" placeholder="Enter phone number"/>
            </div>
            <div class="mb-3 sm:mb-4">
                <label for="network" class="block text-gray-400 mb-1 sm:mb-2"><span class="material-icons mr-1 align-middle text-sm">network_cell</span>NETWORK</label>
                <select id="network" class="w-full p-2 bg-gray-700 text-gray-300 rounded text-sm">
                    <option value="">Select Network</option>
                    <option value="mtn">MTN</option>
                    <option value="at">AirtelTigo</option>
                </select>
            </div>
            <div id="bundle-volume-container"></div>
            <div style="margin-top: 10px;" id="bundle-price" class="mb-3 sm:mb-4 text-gray-300"></div>
            <div class="flex space-x-2">
                <button id="send-bundle" class="bg-red-500 text-white px-3 py-1 sm:px-4 sm:py-2 rounded text-xs sm:text-sm btn-hover"><span class="material-icons mr-1 align-middle text-sm">send</span>Send Bundle</button>
            </div>
            <div id="loader" class="hidden mt-3 sm:mt-4 flex justify-center">
                <div class="spinner"></div>
            </div>
        </div>

        <!-- Order Receipt Section -->
        <div id="order-receipt" class="hidden bg-white text-gray-800 p-4 rounded-lg mt-4">
            <h3 class="text-xl font-semibold mb-2">Order Receipt</h3>
            <div id="receipt-content"></div>
        </div>
    </div>

    <!-- Bottom Bar Navigation -->
    <div class="bg-gray-800 w-full py-2 sm:py-4 flex justify-around items-center fixed bottom-0 z-10">
        <a href="#" id="home-icon" class="text-gray-400 hover:text-yellow-400 p-1 sm:p-2 flex flex-col items-center">
            <span class="material-icons text-lg sm:text-2xl">home</span>
            <span class="text-xs mt-1">Home</span>
        </a>
        <a href="#" id="data-icon" class="text-gray-400 hover:text-yellow-400 p-1 sm:p-2 flex flex-col items-center">
            <span class="material-icons text-lg sm:text-2xl">wifi</span>
            <span class="text-xs mt-1">Data</span>
        </a>
        <a href="#" id="profile-icon" class="text-gray-400 hover:text-yellow-400 p-1 sm:p-2 flex flex-col items-center">
            <span class="material-icons text-lg sm:text-2xl">person</span>
            <span class="text-xs mt-1">Profile</span>
        </a>
        <a href="#" id="orders-icon" class="text-gray-400 hover:text-yellow-400 p-1 sm:p-2 flex flex-col items-center">
            <span class="material-icons text-lg sm:text-2xl">inventory</span>
            <span class="text-xs mt-1">Orders</span>
        </a>
        <a href="#" id="agent-icon" class="text-gray-400 hover:text-yellow-400 p-1 sm:p-2 flex flex-col items-center">
            <span class="material-icons text-lg sm:text-2xl">support_agent</span>
            <span class="text-xs mt-1">Agent</span>
        </a>
        <a href="#" id="logout" class="text-gray-400 hover:text-yellow-400 p-1 sm:p-2 flex flex-col items-center">
            <span class="material-icons text-lg sm:text-2xl">logout</span>
            <span class="text-xs mt-1">Logout</span>
        </a>
    </div>

    <!-- Login Page -->
    <div id="login-page" class="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg w-full max-w-md mt-14 sm:mt-20 mx-2 sm:mx-4">
        <h2 class="text-white text-xl sm:text-2xl font-semibold mb-3 sm:mb-4"><span class="material-icons mr-1 align-middle">login</span>Login</h2>
        <div class="mb-3 sm:mb-4">
            <label for="login-email" class="block text-gray-400 mb-1 sm:mb-2"><span class="material-icons mr-1 align-middle text-sm">email</span>Email</label>
            <input type="email" id="login-email" class="w-full p-2 bg-gray-700 text-gray-300 rounded text-sm" placeholder="Enter your email"/>
        </div>
        <div class="mb-3 sm:mb-4">
            <label for="login-password" class="block text-gray-400 mb-1 sm:mb-2"><span class="material-icons mr-1 align-middle text-sm">lock</span>Password</label>
            <input type="password" id="login-password" class="w-full p-2 bg-gray-700 text-gray-300 rounded text-sm" placeholder="Enter your password"/>
        </div>
        <div class="flex space-x-2">
            <button id="login-button" class="bg-green-500 text-white px-3 py-1 sm:px-4 sm:py-2 rounded text-xs sm:text-sm btn-hover"><span class="material-icons mr-1 align-middle text-sm">login</span>Login</button>
            <button id="go-to-signup" class="bg-blue-500 text-white px-3 py-1 sm:px-4 sm:py-2 rounded text-xs sm:text-sm btn-hover"><span class="material-icons mr-1 align-middle text-sm">person_add</span>Sign Up</button>
            <button id="go-to-reset" class="bg-yellow-500 text-white px-3 py-1 sm:px-4 sm:py-2 rounded text-xs sm:text-sm btn-hover"><span class="material-icons mr-1 align-middle text-sm">key</span>Reset</button>
        </div>
    </div>

    <!-- Sign Up Page -->
    <div id="signup-page" class="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg w-full max-w-md mt-14 sm:mt-20 mx-2 sm:mx-4 hidden">
        <h2 class="text-white text-xl sm:text-2xl font-semibold mb-3 sm:mb-4"><span class="material-icons mr-1 align-middle">person_add</span>Sign Up</h2>
        <div class="mb-3 sm:mb-4">
            <label for="signup-name" class="block text-gray-400 mb-1 sm:mb-2"><span class="material-icons mr-1 align-middle text-sm">person</span>Name</label>
            <input type="text" id="signup-name" class="w-full p-2 bg-gray-700 text-gray-300 rounded text-sm" placeholder="Enter your name"/>
        </div>
        <div class="mb-3 sm:mb-4">
            <label for="signup-email" class="block text-gray-400 mb-1 sm:mb-2"><span class="material-icons mr-1 align-middle text-sm">email</span>Email</label>
            <input type="email" id="signup-email" class="w-full p-2 bg-gray-700 text-gray-300 rounded text-sm" placeholder="Enter your email"/>
        </div>
        <div class="mb-3 sm:mb-4">
            <label for="signup-phone" class="block text-gray-400 mb-1 sm:mb-2"><span class="material-icons mr-1 align-middle text-sm">phone</span>Phone</label>
            <input type="tel" id="signup-phone" class="w-full p-2 bg-gray-700 text-gray-300 rounded text-sm" placeholder="Enter your phone number"/>
        </div>
        <div class="mb-3 sm:mb-4">
            <label for="signup-password" class="block text-gray-400 mb-1 sm:mb-2"><span class="material-icons mr-1 align-middle text-sm">lock</span>Password</label>
            <input type="password" id="signup-password" class="w-full p-2 bg-gray-700 text-gray-300 rounded text-sm" placeholder="Enter your password"/>
        </div>
        <div class="mb-3 sm:mb-4">
            <label for="signup-confirm-password" class="block text-gray-400 mb-1 sm:mb-2"><span class="material-icons mr-1 align-middle text-sm">lock</span>Confirm Password</label>
            <input type="password" id="signup-confirm-password" class="w-full p-2 bg-gray-700 text-gray-300 rounded text-sm" placeholder="Confirm your password"/>
        </div>
        <div class="flex space-x-2">
            <button id="signup-button" class="bg-green-500 text-white px-3 py-1 sm:px-4 sm:py-2 rounded text-xs sm:text-sm btn-hover"><span class="material-icons mr-1 align-middle text-sm">person_add</span>Sign Up</button>
            <button id="go-to-login" class="bg-blue-500 text-white px-3 py-1 sm:px-4 sm:py-2 rounded text-xs sm:text-sm btn-hover"><span class="material-icons mr-1 align-middle text-sm">login</span>Login</button>
        </div>
    </div>

    <!-- Reset Password Page -->
    <div id="reset-page" class="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg w-full max-w-md mt-14 sm:mt-20 mx-2 sm:mx-4 hidden">
        <h2 class="text-white text-xl sm:text-2xl font-semibold mb-3 sm:mb-4"><span class="material-icons mr-1 align-middle">key</span>Reset Password</h2>
        <div class="mb-3 sm:mb-4">
            <label for="reset-email" class="block text-gray-400 mb-1 sm:mb-2"><span class="material-icons mr-1 align-middle text-sm">email</span>Email</label>
            <input type="email" id="reset-email" class="w-full p-2 bg-gray-700 text-gray-300 rounded text-sm" placeholder="Enter your email"/>
        </div>
        <div class="flex space-x-2">
            <button id="reset-button" class="bg-yellow-500 text-white px-3 py-1 sm:px-4 sm:py-2 rounded text-xs sm:text-sm btn-hover"><span class="material-icons mr-1 align-middle text-sm">key</span>Reset</button>
            <button id="go-to-login-from-reset" class="bg-blue-500 text-white px-3 py-1 sm:px-4 sm:py-2 rounded text-xs sm:text-sm btn-hover"><span class="material-icons mr-1 align-middle text-sm">arrow_back</span>Back</button>
        </div>
    </div>

    <!-- Profile Page -->
    <div id="profile-page" class="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg w-full max-w-md mt-14 sm:mt-20 mx-2 sm:mx-4 hidden">
        <h2 class="text-white text-xl sm:text-2xl font-semibold mb-3 sm:mb-4"><span class="material-icons mr-1 align-middle">person</span>Profile</h2>
        <div id="profile-info" class="text-gray-300 mb-4"></div>
        <div id="edit-profile" class="mt-3 sm:mt-4">
            <h3 class="text-white text-lg sm:text-xl font-semibold mb-2">Edit Profile</h3>
            <div class="mb-3 sm:mb-4">
                <label for="edit-name" class="block text-gray-400 mb-1 sm:mb-2"><span class="material-icons mr-1 align-middle text-sm">person</span>Name</label>
                <input type="text" id="edit-name" class="w-full p-2 bg-gray-700 text-gray-300 rounded text-sm" placeholder="Enter your name"/>
            </div>
            <div class="mb-3 sm:mb-4">
                <label for="edit-phone" class="block text-gray-400 mb-1 sm:mb-2"><span class="material-icons mr-1 align-middle text-sm">phone</span>Phone</label>
                <input type="tel" id="edit-phone" class="w-full p-2 bg-gray-700 text-gray-300 rounded text-sm" placeholder="Enter your phone number"/>
            </div>
            <button id="save-profile" class="bg-green-500 text-white px-3 py-1 sm:px-4 sm:py-2 rounded text-xs sm:text-sm btn-hover"><span class="material-icons mr-1 align-middle text-sm">save</span>Save Changes</button>
            <p id="edit-count" class="text-gray-400 mt-2 text-xs">Edits remaining: 3</p>
        </div>
    </div>

    <!-- Orders Page -->
    <div id="orders-page" class="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg w-full max-w-md mt-14 sm:mt-20 mx-2 sm:mx-4 hidden">
        <h2 class="text-white text-xl sm:text-2xl font-semibold mb-3 sm:mb-4"><span class="material-icons mr-1 align-middle">inventory</span>Your Orders</h2>
        <div id="orders-list" class="text-gray-300 space-y-3 max-h-96 overflow-y-auto pr-2"></div>
    </div>

    <!-- Agent Page -->
    <div id="agent-page" class="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg w-full max-w-md mt-14 sm:mt-20 mx-2 sm:mx-4 hidden">
        <h2 class="text-white text-xl sm:text-2xl font-semibold mb-3 sm:mb-4"><span class="material-icons mr-1 align-middle">support_agent</span>Agent Support</h2>
        <div class="text-gray-300 mb-4">
            <p>Need help? Contact our support team:</p>
            <p class="mt-2"><span class="material-icons mr-1 align-middle">phone</span>Phone: +1 (234) 567-8900</p>
            <p class="mt-2"><span class="material-icons mr-1 align-middle">email</span>Email: support@gigshub.com</p>
        </div>
        <div class="mt-4">
            <h3 class="text-white text-lg font-semibold mb-2">Send us a message</h3>
            <textarea id="support-message" class="w-full p-2 bg-gray-700 text-gray-300 rounded text-sm" rows="4" placeholder="Type your message here..."></textarea>
            <button id="send-support-message" class="mt-2 bg-blue-500 text-white px-3 py-1 sm:px-4 sm:py-2 rounded text-xs sm:text-sm btn-hover"><span class="material-icons mr-1 align-middle text-sm">send</span>Send Message</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getDatabase, ref, set, push, get, query, orderByChild, equalTo, update } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAxdZufEUNjmHNrOtOH4GFtd2joqJzs_sk",
            authDomain: "gigs-hub-a0f14.firebaseapp.com",
            projectId: "gigs-hub-a0f14",
            storageBucket: "gigs-hub-a0f14.firebasestorage.app",
            messagingSenderId: "997297677705",
            appId: "1:997297677705:web:34d11ec60893183499ed58"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // Initialize Notyf
        const notyf = new Notyf({
            duration: 3000,
            position: {x: 'right', y: 'top'},
        });

        // Elements
        const mainContent = document.getElementById('main-content');
        const loginPage = document.getElementById('login-page');
        const signupPage = document.getElementById('signup-page');
        const resetPage = document.getElementById('reset-page');
        const profilePage = document.getElementById('profile-page');
        const ordersPage = document.getElementById('orders-page');
        const agentPage = document.getElementById('agent-page');
        const loader = document.getElementById('loader');
        const orderReceipt = document.getElementById('order-receipt');

        // Network prices and volumes
        const networkData = {
            mtn: {
                prices: {
                    '1GB': 5.50,
                    '2GB': 12,
                    '5GB': 27,
                    '10GB': 27
                },
                volumes: ['1GB', '2GB', '5GB', '10GB']
            },
            at: {
                prices: {
                    '1GB': 5, '2GB': 9, '3GB': 13, '4GB': 18, '5GB': 20,
                    '6GB': 23, '7GB': 27, '8GB': 35, '9GB': 36, '10GB': 42,
                    '15GB': 61.5, '20GB': 80, '50GB': 140, '100GB': 250,
                },
                volumes: ['1GB', '2GB', '3GB', '4GB', '5GB', '6GB', '7GB', '8GB', '9GB', '10GB', '15GB', '20GB', '50GB', '100GB']
            }
        };

        // Helper function to hide all pages
        function hideAllPages() {
            mainContent.classList.add('hidden');
            loginPage.classList.add('hidden');
            signupPage.classList.add('hidden');
            resetPage.classList.add('hidden');
            profilePage.classList.add('hidden');
            ordersPage.classList.add('hidden');
            agentPage.classList.add('hidden');
        }

        // Helper function to set active nav item
        function setActiveNavItem(id) {
            document.querySelectorAll('.bottom-0 a').forEach(el => el.classList.remove('active-nav'));
            document.getElementById(id).classList.add('active-nav');
        }

        // Authentication state observer
        onAuthStateChanged(auth, (user) => {
            if (user) {
                hideAllPages();
                mainContent.classList.remove('hidden');
                if (!localStorage.getItem('loggedInBefore')) {
                    notyf.success('Logged in successfully!');
                    localStorage.setItem('loggedInBefore', 'true');
                }
                loadUserProfile(user);
                loadUserOrders(user);
                hideAllSections();
                document.getElementById('home-section').classList.remove('hidden');
                loadHomePageData(user);
                setActiveNavItem('home-icon');
            } else {
                hideAllPages();
                loginPage.classList.remove('hidden');
            }
        });

        // Login
        document.getElementById('login-button').addEventListener('click', () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            signInWithEmailAndPassword(auth, email, password)
                .then(() => {
                    notyf.success('Logged in successfully!');
                })
                .catch(error => notyf.error(error.message));
        });

        // Sign Up
        document.getElementById('signup-button').addEventListener('click', () => {
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const phone = document.getElementById('signup-phone').value;
            const password = document.getElementById('signup-password').value;
            const confirmPassword = document.getElementById('signup-confirm-password').value;

            if (password !== confirmPassword) {
                notyf.error('Passwords do not match');
                return;
            }

            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    // Save additional user info to the database
                    const user = userCredential.user;
                    return set(ref(database, 'users/' + user.uid), {
                        name: name,
                        email: email,
                        phone: phone,
                        editCount: 3
                    });
                })
                .then(() => {
                    notyf.success('Account created successfully!');
                })
                .catch(error => notyf.error(error.message));
        });

        // Reset Password
        document.getElementById('reset-button').addEventListener('click', () => {
            const email = document.getElementById('reset-email').value;
            sendPasswordResetEmail(auth, email)
                .then(() => {
                    notyf.success('Password reset email sent');
                })
                .catch(error => notyf.error(error.message));
        });

        // Navigation
        document.getElementById('go-to-signup').addEventListener('click', () => {
            hideAllPages();
            signupPage.classList.remove('hidden');
        });

        document.getElementById('go-to-login').addEventListener('click', () => {
            hideAllPages();
            loginPage.classList.remove('hidden');
        });

        document.getElementById('go-to-reset').addEventListener('click', () => {
            hideAllPages();
            resetPage.classList.remove('hidden');
        });

        document.getElementById('go-to-login-from-reset').addEventListener('click', () => {
            hideAllPages();
            loginPage.classList.remove('hidden');
        });

        // Logout
        document.getElementById('logout').addEventListener('click', () => {
            signOut(auth)
                .then(() => {
                    notyf.success('Logged out successfully!');
                    localStorage.removeItem('loggedInBefore');
                })
                .catch(error => notyf.error(error.message));
        });

        // Bottom navbar functionality
        document.getElementById('home-icon').addEventListener('click', () => {
            if (auth.currentUser) {
                hideAllPages();
                mainContent.classList.remove('hidden');
                hideAllSections();
                document.getElementById('home-section').classList.remove('hidden');
                loadHomePageData(auth.currentUser);
                setActiveNavItem('home-icon');
            } else {
                notyf.error('Please log in to access this section');
            }
        });

        document.getElementById('data-icon').addEventListener('click', () => {
            if (auth.currentUser) {
                hideAllPages();
                mainContent.classList.remove('hidden');
                hideAllSections();
                document.getElementById('bundle-purchase-section').classList.remove('hidden');
                setActiveNavItem('data-icon');
            } else {
                notyf.error('Please log in to access this section');
            }
        });

        document.getElementById('profile-icon').addEventListener('click', () => {
            if (auth.currentUser) {
                hideAllPages();
                profilePage.classList.remove('hidden');
                loadUserProfile(auth.currentUser);
                setActiveNavItem('profile-icon');
            } else {
                notyf.error('Please log in to access this section');
            }
        });

        document.getElementById('orders-icon').addEventListener('click', () => {
            if (auth.currentUser) {
                hideAllPages();
                ordersPage.classList.remove('hidden');
                loadUserOrders(auth.currentUser);
                setActiveNavItem('orders-icon');
            } else {
                notyf.error('Please log in to access this section');
            }
        });

        document.getElementById('agent-icon').addEventListener('click', () => {
            if (auth.currentUser) {
                hideAllPages();
                agentPage.classList.remove('hidden');
                setActiveNavItem('agent-icon');
            } else {
                notyf.error('Please log in to access this section');
            }
        });

        // Purchase button
        document.getElementById('purchase-button').addEventListener('click', () => {
            hideAllPages();
            mainContent.classList.remove('hidden');
            hideAllSections();
            document.getElementById('bundle-purchase-section').classList.remove('hidden');
            setActiveNavItem('data-icon');
        });

        // Add this new function to hide all sections
        function hideAllSections() {
            document.getElementById('home-section').classList.add('hidden');
            document.getElementById('bundle-purchase-section').classList.add('hidden');
            orderReceipt.classList.add('hidden');
        }

        // Network selection change handler
        document.getElementById('network').addEventListener('change', updateBundleOptions);

        // Update bundle options based on selected network
        function updateBundleOptions() {
            const network = document.getElementById('network').value;
            const bundleVolumeContainer = document.getElementById('bundle-volume-container');
            
            // Clear previous content
            bundleVolumeContainer.innerHTML = '';

            if (network) {
                // Create new select element
                const bundleVolumeSelect = document.createElement('select');
                bundleVolumeSelect.id = 'bundle-volume';
                bundleVolumeSelect.className = 'w-full p-2 bg-gray-700 text-gray-300 rounded text-sm';
                bundleVolumeSelect.innerHTML = '<option value="">Select package</option>';

                networkData[network].volumes.forEach(volume => {
                    const option = document.createElement('option');
                    option.value = volume;
                    option.textContent = `${volume} - GHS ${networkData[network].prices[volume].toFixed(2)}`;
                    bundleVolumeSelect.appendChild(option);
                });

                // Create label for the new select
                const label = document.createElement('label');
                label.htmlFor = 'bundle-volume';
                label.className = 'block text-gray-400 mb-1 sm:mb-2';
                label.innerHTML = '<span class="material-icons mr-1 align-middle text-sm">data_usage</span>BUNDLE VOLUME';

                // Append the new elements
                bundleVolumeContainer.appendChild(label);
                bundleVolumeContainer.appendChild(bundleVolumeSelect);

                // Add event listener to update price
                bundleVolumeSelect.addEventListener('change', updatePrice);
            }

            updatePrice();
        }

        // Update price based on selected network and volume
        function updatePrice() {
            const network = document.getElementById('network').value;
            const volumeSelect = document.getElementById('bundle-volume');
            const priceElement = document.getElementById('bundle-price');

            if (network && volumeSelect && volumeSelect.value) {
                const volume = volumeSelect.value;
                const price = networkData[network].prices[volume];
                priceElement.textContent = `Price: GHS ${price.toFixed(2)}`;
            } else {
                priceElement.textContent = '';
            }
        }

        // Send Bundle
        document.getElementById('send-bundle').addEventListener('click', () => {
            const network = document.getElementById('network').value;
            const phoneNumber = document.getElementById('phone-number').value;
            const bundleVolumeSelect = document.getElementById('bundle-volume');
            
            if (!bundleVolumeSelect || network === '' || bundleVolumeSelect.value === '' || phoneNumber === '') {
                notyf.error('Please select a network, enter phone number, and select a package');
                return;
            }

            const bundleVolume = bundleVolumeSelect.value;

            // Show loader
            loader.classList.remove('hidden');

            // Calculate price
            const bundlePrice = networkData[network].prices[bundleVolume];

            // Initialize Paystack payment
            const handler = PaystackPop.setup({
                key: 'pk_test_465904782c379e7b5eb53646745fec92442a3af4',
                email: auth.currentUser.email,
                amount: bundlePrice * 100, // Amount in pesewas
                currency: 'GHS',
                ref: '' + Math.floor((Math.random() * 1000000000) + 1),
                callback: function(response) {
                    // Hide loader
                    loader.classList.add('hidden');
                    notyf.success('Payment successful. Transaction reference: ' + response.reference);

                    // Call the API to send the bundle
                    sendBundle(network, phoneNumber, bundleVolume, response.reference);
                },
                onClose: function() {
                    // Hide loader
                    loader.classList.add('hidden');
                    notyf.warning('Transaction was not completed, window closed.');
                }
            });
            handler.openIframe();
        });

        // Function to send bundle via API
        async function sendBundle(network, phone, volume, reference) {
            const apiUrl = `https://console.hubnet.app/live/api/context/business/transaction/${network}-new-transaction`;
            const apiKey = 'v61fayeo5LeSlVy1AgjHqgXFrYAgogDr2E7'; // Replace with your actual API key

            const payload = {
                phone: phone,
                volume: parseFloat(volume) * 1000, // Convert GB to MB
                reference: reference,
                referrer: auth.currentUser.phoneNumber || '',
                webhook: 'https://your-webhook-url.com' // Replace with your actual webhook URL
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'token': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.status) {
                    notyf.success('Bundle sent successfully!');
                    saveOrderToDatabase(network, phone, volume, reference, data.transaction_id);
                    displayOrderReceipt(network, phone, volume, reference, data.transaction_id);
                } else {
                    notyf.error('Failed to send bundle: ' + data.message);
                }
            } catch (error) {
                notyf.error('Error sending bundle: ' + error.message);
            }
        }

        // Function to save order to database
        function saveOrderToDatabase(network, phone, volume, reference, transactionId) {
            const orderData = {
                network: network,
                phoneNumber: phone,
                bundleVolume: volume,
                price: networkData[network].prices[volume],
                userId: auth.currentUser.uid,
                transactionReference: reference,
                transactionId: transactionId,
                timestamp: new Date().toISOString(),
                status: 'pending'
            };

            push(ref(database, 'orders'), orderData)
                .then(() => {
                    notyf.success('Order saved successfully');
                    loadUserOrders(auth.currentUser);
                    loadHomePageData(auth.currentUser);
                })
                .catch(error => notyf.error('Error saving order: ' + error.message));
        }

        // Function to display order receipt
        function displayOrderReceipt(network, phone, volume, reference, transactionId) {
            const receiptContent = document.getElementById('receipt-content');
            const price = networkData[network].prices[volume];
            
            receiptContent.innerHTML = `
                <p><strong>Network:</strong> ${network.toUpperCase()}</p>
                <p><strong>Phone Number:</strong> ${phone}</p>
                <p><strong>Bundle Volume:</strong> ${volume}</p>
                <p><strong>Price:</strong> GHS ${price.toFixed(2)}</p>
                <p><strong>Transaction Reference:</strong> ${reference}</p>
                <p><strong>Transaction ID:</strong> ${transactionId}</p>
                <p><strong>Date:</strong> ${new Date().toLocaleString()}</p>
                <p><strong>Status:</strong> Pending</p>
            `;

            hideAllSections();
            orderReceipt.classList.remove('hidden');
        }

        // Load user profile
        function loadUserProfile(user) {
            const profileInfo = document.getElementById('profile-info');
            get(ref(database, 'users/' + user.uid))
                .then((snapshot) => {
                    const userData = snapshot.val();
                    if (userData) {
                        profileInfo.innerHTML = `
                            <p class="mb-2"><span class="material-icons mr-1 align-middle text-sm">person</span><strong>Name:</strong> ${userData.name}</p>
                            <p class="mb-2"><span class="material-icons mr-1 align-middle text-sm">email</span><strong>Email:</strong> ${userData.email}</p>
                            <p class="mb-2"><span class="material-icons mr-1 align-middle text-sm">phone</span><strong>Phone:</strong> ${userData.phone}</p>
                        `;
                        document.getElementById('edit-name').value = userData.name;
                        document.getElementById('edit-phone').value = userData.phone;
                        document.getElementById('edit-count').textContent = `Edits remaining: ${userData.editCount || 0}`;
                    } else {
                        profileInfo.innerHTML = 'User data not found.';
                    }
                })
                .catch(error => {
                    profileInfo.innerHTML = 'Error loading profile: ' + error.message;
                });
        }

        // Save profile changes
        document.getElementById('save-profile').addEventListener('click', () => {
            const user = auth.currentUser;
            if (user) {
                const newName = document.getElementById('edit-name').value;
                const newPhone = document.getElementById('edit-phone').value;

                get(ref(database, 'users/' + user.uid))
                    .then((snapshot) => {
                        const userData = snapshot.val();
                        if (userData && userData.editCount > 0) {
                            update(ref(database, 'users/' + user.uid), {
                                name: newName,
                                phone: newPhone,
                                editCount: userData.editCount - 1
                            })
                                .then(() => {
                                    notyf.success('Profile updated successfully');
                                    loadUserProfile(user);
                                })
                                .catch(error => notyf.error('Error updating profile: ' + error.message));
                        } else {
                            notyf.error('You have reached the maximum number of edits');
                        }
                    })
                    .catch(error => notyf.error('Error fetching user data: ' + error.message));
            }
        });

        // Load user orders
        function loadUserOrders(user) {
            const ordersList = document.getElementById('orders-list');
            ordersList.innerHTML = 'Loading orders...';

            get(query(ref(database, 'orders'), orderByChild('userId'), equalTo(user.uid)))
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        let ordersHtml = '';
                        snapshot.forEach((childSnapshot) => {
                            const order = childSnapshot.val();
                            if (order && order.network) {
                                ordersHtml += `
                                    <div class="mb-3 p-3 bg-gray-700 rounded text-xs sm:text-sm">
                                        <p class="mb-1"><span class="material-icons mr-1 align-middle text-xs">network_cell</span><strong>Network:</strong> ${order.network.toUpperCase()}</p>
                                        <p class="mb-1"><span class="material-icons mr-1 align-middle text-xs">phone</span><strong>Phone:</strong> ${order.phoneNumber}</p>
                                        <p class="mb-1"><span class="material-icons mr-1 align-middle text-xs">wifi</span><strong>Bundle:</strong> ${order.bundleVolume}</p>
                                        <p class="mb-1"><span class="material-icons mr-1 align-middle text-xs">attach_money</span><strong>Price:</strong> GHS ${order.price.toFixed(2)}</p>
                                        <p class="mb-1"><span class="material-icons mr-1 align-middle text-xs">event</span><strong>Date:</strong> ${new Date(order.timestamp).toLocaleString()}</p>
                                        <p class="mb-1"><span class="material-icons mr-1 align-middle text-xs">tag</span><strong>Ref:</strong> ${order.transactionReference}</p>
                                        <p><span class="material-icons mr-1 align-middle text-xs">info</span><strong>Status:</strong> ${order.status || 'Pending'}</p>
                                    </div>
                                `;
                            }
                        });
                        ordersList.innerHTML = ordersHtml || 'No orders found.';
                    } else {
                        ordersList.innerHTML = 'No orders found.';
                    }
                })
                .catch((error) => {
                    ordersList.innerHTML = 'Error loading orders: ' + error.message;
                });
        }

        // Load home page data
        function loadHomePageData(user) {
            const userGreeting = document.getElementById('user-greeting');
            const totalSpent = document.getElementById('total-spent');
            const ordersMade = document.getElementById('orders-made');
            const dataActivated = document.getElementById('data-activated');
            const lastOrder = document.getElementById('last-order');

            get(ref(database, 'users/' + user.uid))
                .then((snapshot) => {
                    const userData = snapshot.val();
                    if (userData && userData.name) {
                        userGreeting.textContent = `Welcome, ${userData.name}!`;
                    } else {
                        userGreeting.textContent = 'Welcome!';
                    }
                })
                .catch(error => {
                    console.error('Error loading user data:', error);
                    userGreeting.textContent = 'Welcome!';
                });

            get(query(ref(database, 'orders'), orderByChild('userId'), equalTo(user.uid)))
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        let totalAmount = 0;
                        let totalData = 0;
                        let orderCount = 0;
                        let lastOrderDate = null;

                        snapshot.forEach((childSnapshot) => {
                            const order = childSnapshot.val();
                            if (order && order.price && order.bundleVolume && order.timestamp) {
                                totalAmount += order.price;
                                totalData += parseFloat(order.bundleVolume);
                                orderCount++;

                                const orderDate = new Date(order.timestamp);
                                if (!lastOrderDate || orderDate > lastOrderDate) {
                                    lastOrderDate = orderDate;
                                }
                            }
                        });

                        totalSpent.textContent = `GHS ${totalAmount.toFixed(2)}`;
                        ordersMade.textContent = orderCount;
                        dataActivated.textContent = `${totalData.toFixed(2)}GB`;
                        lastOrder.textContent = lastOrderDate ? lastOrderDate.toLocaleDateString() : 'N/A';
                    } else {
                        totalSpent.textContent = 'GHS 0.00';
                        ordersMade.textContent = '0';
                        dataActivated.textContent = '0GB';
                        lastOrder.textContent = 'N/A';
                    }
                })
                .catch((error) => {
                    console.error('Error loading orders:', error);
                    totalSpent.textContent = 'Error';
                    ordersMade.textContent = 'Error';
                    dataActivated.textContent = 'Error';
                    lastOrder.textContent = 'Error';
                });
        }

        // Send support message
        document.getElementById('send-support-message').addEventListener('click', () => {
            const message = document.getElementById('support-message').value;
            if (message.trim() === '') {
                notyf.error('Please enter a message');
                return;
            }

            const user = auth.currentUser;
            if (!user) {
                notyf.error('You must be logged in to send a message');
                return;
            }

            // Get user data from the database
            get(ref(database, 'users/' + user.uid))
                .then((snapshot) => {
                    const userData = snapshot.val();
                    if (userData) {
                        // Save the message to the database
                        const supportMessage = {
                            userId: user.uid,
                            name: userData.name,
                            email: userData.email,
                            phone: userData.phone,
                            message: message,
                            timestamp: new Date().toISOString()
                        };

                        push(ref(database, 'support_messages'), supportMessage)
                            .then(() => {
                                notyf.success('Message sent to support team');
                                document.getElementById('support-message').value = '';
                            })
                            .catch((error) => {
                                notyf.error('Error sending message: ' + error.message);
                            });
                    } else {
                        notyf.error('User data not found');
                    }
                })
                .catch((error) => {
                    notyf.error('Error fetching user data: ' + error.message);
                });
        });
    </script>
</body>
</html>

